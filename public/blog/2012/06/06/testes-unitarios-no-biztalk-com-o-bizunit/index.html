
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Testes unitários no BizTalk com o BizUnit - Temple Coding</title>
  <meta name="author" content="Thiago Temple">

  
  <meta name="description" content="Hoje vou falar um pouco sobre como fazer &ldquo;testes unitários&rdquo; no BizTalk. Tenho que usar as aspas pra dizer testes unitários porque o &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://templecoding.com/blog/2012/06/06/testes-unitarios-no-biztalk-com-o-bizunit">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Temple Coding" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Temple Coding</a></h1>
  
    <h2>código, tecnologia e outras nerdices</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:templecoding.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Procurar"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Arquivos</a></li>
  <li><a href="/blog/categories/videocast">Videocast</a></li>
  <li><a href="/sobre">Sobre</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Testes unitários no BizTalk com o BizUnit</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-06T00:00:00-04:00" pubdate data-updated="true">06/06/2012</time>
        
         | <a href="#disqus_thread">Comentários</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Hoje vou falar um pouco sobre como fazer &ldquo;testes unitários&rdquo; no BizTalk. Tenho que usar as aspas pra dizer testes unitários porque o BizTalk, sendo uma ferramenta de integração, só podemos fazer testes integrados. Mas a unidade nesse caso, pode ser definida como sendo cada integração diferente.</p>

<p>O <a href="https://github.com/vintem/OrderProcessing">código está disponivel no github</a>.</p>

<p>Vou começar de uma forma bem simples, apenas apresentando o BizUnit. Primeiro a definição como diz no site do próprio BizUnit:</p>

<blockquote>BizUnit enables automated tests to be rapidly developed. BizUnit is a flexible and extensible declarative test framework targeted that rapidly enables the automated testing of distributed systems, for example it is widely used to test BizTalk solutions. BizUnit is fully extensible. Its approach is to enable test cases to be constructed from generic reusable test steps, test cases are defined in XML which allows them to be auto-generated and also enables the ‘fixing up’ of Url’s for different environments, e.g. test, staging and production environments. Defining test cases in XML enables test cases to be auto-generated.</blockquote>


<p>A primeira coisa que preciso dizer, é que apesar do BizUnit funcionar, parece ser um projeto open source meio parado, quero dizer, não encontrei (até o momento desse post) nem o código fonte disponivel para baixa-lo. E como a maioria dos projetos open source, a documentação não é o forte. Por exemplo, já na definição do framework diz que podemos definir os casos de testes em arquivos XML, isso é verdade, mas também podemos fazer isso em código, no C#, como qualquer outro teste unitário. E é isso que vou fazer nesse exemplo.</p>

<p>O cenário para esse teste será bem simples, um pedido terá origem como um arquivo XML em uma pasta e caso ele tenha um valor total maior que 1000 será direcionado para uma pasta de pedidos especiais, senão, ele ira para uma pasta de pedidos regulares.</p>

<p><a href="http://templecoding.com/wp-content/uploads/2012/06/fluxo_pedido1.png"><img class="aligncenter size-full wp-image-443" title="Fluxo de um pedido" src="http://templecoding.com/wp-content/uploads/2012/06/fluxo_pedido1.png" alt="" width="626" height="302" /></a></p>

<p>O que queremos com um teste unitário para esse caso, é que ele possa ser executado diversas vezes de uma forma simples e verificável.</p>

<p>O nosso esquema XML também vai manter a simplicidade:</p>

<pre>   00001
    Thiago Temple
    2012-06-05T00:00:00
    600</pre>


<p>Para o projeto no BizTalk apenas vou gerar o Schema para essa mensagem, gerar um Distinguished Field no campo Total para poder fazer o roteamento na própria porta.</p>

<p>Veja como ficou a solução:</p>

<p><a href="http://templecoding.com/wp-content/uploads/2012/06/visual_studio_solution1.png"><img class="aligncenter size-full wp-image-448" title="visual_studio_solution" src="http://templecoding.com/wp-content/uploads/2012/06/visual_studio_solution1.png" alt="" width="282" height="251" /></a></p>

<p>E os filtros nas portas:</p>

<p><a href="http://templecoding.com/wp-content/uploads/2012/06/Send_standard_port_filter1.png"><img class="aligncenter size-medium wp-image-449" title="Send_File_StandardOrder_Filter" src="http://templecoding.com/wp-content/uploads/2012/06/Send_standard_port_filter1-300x258.png" alt="" width="300" height="258" />
</a><a href="http://templecoding.com/wp-content/uploads/2012/06/Send_special_port_filter1.png"><img class="aligncenter size-medium wp-image-450" title="Send_File_SpecialOrder_Filter" src="http://templecoding.com/wp-content/uploads/2012/06/Send_special_port_filter1-300x260.png" alt="" width="300" height="260" /></a></p>

<p>Com tudo explicado, vamos ao teste. O que vamos verificar nesse teste é que ao salvar um arquivo na pasta de entrada, o mesmo deverá ser roteado para a pasta correta. Portanto criei dois arquivos com dados de teste, um com valor maior de 1000 chamado SpecialOrder.xml e outro com um valor menor de 1000 chamado StandardOrder.xml.</p>

<p>Para o teste estou usando o MSTest mas também é possivel usar o NUnit facilmente.</p>

<p>Começamos com a classe de teste para o caso regular que chamei de ProcessingStandardOrder.</p>

<pre class="brush: csharp;">[TestClass]
    public class ProcessingStandardOrder
    {
        [TestMethod]
        public void StandardOrderShouldBeSavedInCorrectFolder()
        {
            var testCase = new TestCase { Name = "Test that standard order is saved in correct folder" };

            testCase.SetupSteps.Add(DeleteFilesStep());

            testCase.ExecutionSteps.Add(CreateFileStep());

            testCase.ExecutionSteps.Add(ValidateFileExits());

            var bizUnit = new BizUnit.BizUnit(testCase);
            bizUnit.RunTest();
        }

        private TestStepBase ValidateFileExits()
        {
            var validateFileExistsSTep = new FileReadMultipleStep
            {
                DirectoryPath = @"C:Biztalk InOutOrderProcessingStandard",
                SearchPattern = "*.xml",
                ExpectedNumberOfFiles = 1,
                Timeout = 3000,
                DeleteFiles = true
            };
            return validateFileExistsSTep;
        }

        private static CreateStep CreateFileStep()
        {
            var createImportTestFile = new CreateStep
            {
                CreationPath = @"C:Biztalk InOutOrderProcessingInStandardOrder.xml",
                DataSource = new FileDataLoader { FilePath = @"......OrderProcessing.TestsTestDataStandardOrder.xml" }
            };
            return createImportTestFile;
        }

        private static DeleteStep DeleteFilesStep()
        {
            var deleteFiles = new DeleteStep
            {
                FilePathsToDelete = new Collection { @"C:Biztalk InOutOrderProcessingIn*.xml", @"C:Biztalk InOutOrderProcessingStandard*.xml" }
            };
            return deleteFiles;
        }
    }</pre>


<p>O codigo é bem simples. O importante é saber que o BizUnit sempre vai executar os SetupSteps antes dos ExecutionSteps e depois ainda vai executar todos os CleanupSteps. Criei um TestCase, limpei o diretório de entrada e de destino, copiei o meu arquivo com os dados de teste e verifiquei que o mesmo estava na pasta esperada.</p>

<p>O importante é notar o funcionamento do BizUnit. É preciso criar um TestCase e criar um BizUnit passando o teste. Veja também que no método ValidateFileExists eu adicionei um Timeout de 3000 milisegundos, isso é importante porque precisamos esperar que o arquivo seja processado pelo BizTalk, caso contrário é possivel que o teste rode antes que o BizTalk processe o arquivo e então o teste falhará.</p>

<p>Por fim a classe que testa o caso especial ProcessingSpecialOrder:</p>

<pre class="brush: csharp;">[TestClass]
    public class ProcessingSpecialOrder
    {
        [TestMethod]
        public void SpecialOrderShouldBeSavedInCorrectFolder()
        {
            var testCase = new TestCase { Name = "Test that special order is saved in correct folder" };

            testCase.SetupSteps.Add(DeleteFilesStep());

            testCase.ExecutionSteps.Add(CreateFileStep());

            testCase.ExecutionSteps.Add(ValidateFileExits());

            var bizUnit = new BizUnit.BizUnit(testCase);
            bizUnit.RunTest();
        }

        private TestStepBase ValidateFileExits()
        {
            var validateFileExistsSTep = new FileReadMultipleStep
            {
                DirectoryPath = @"C:Biztalk InOutOrderProcessingSpecial",
                SearchPattern = "*.xml",
                ExpectedNumberOfFiles = 1,
                Timeout = 3000,
                DeleteFiles = true
            };
            return validateFileExistsSTep;
        }

        private static CreateStep CreateFileStep()
        {
            var createImportTestFile = new CreateStep
            {
                CreationPath = @"C:Biztalk InOutOrderProcessingInSpecialOrder.xml",
                DataSource = new FileDataLoader { FilePath = @"......OrderProcessing.TestsTestDataSpecialOrder.xml" }
            };
            return createImportTestFile;
        }

        private static DeleteStep DeleteFilesStep()
        {
            var deleteFiles = new DeleteStep
            {
                FilePathsToDelete = new Collection { @"C:Biztalk InOutOrderProcessingIn*.xml", @"C:Biztalk InOutOrderProcessingSpecial*.xml" }
            };
            return deleteFiles;
        }
    }</pre>


<p>É isso, lembrando que o <a href="https://github.com/vintem/OrderProcessing">código está disponivel no github</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Postado por <span class="fn">Thiago Temple</span></span>

      








  


<time datetime="2012-06-06T00:00:00-04:00" pubdate data-updated="true">06/06/2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/desenvolvimento/'>Desenvolvimento</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://templecoding.com/blog/2012/06/06/testes-unitarios-no-biztalk-com-o-bizunit/" data-via="vintem12" data-counturl="http://templecoding.com/blog/2012/06/06/testes-unitarios-no-biztalk-com-o-bizunit/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/09/26/injecao-de-dependencia-em-atributosfiltros-do-mvc/" title="Previous Post: Injeção de Dependência em Atributos/Filtros do MVC">&laquo; Injeção de Dependência em Atributos/Filtros do MVC</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/09/25/001-videocast-produtividade-com-asp-net-mvc-4/" title="Next Post: 001 - VideoCast - Produtividade com ASP.NET MVC 4">001 - VideoCast - Produtividade com ASP.NET MVC 4 &raquo;</a>
      
    </p>
  </footer>
</article>


</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/07/30/responsabilidade-unica-com-javascript/">Só é uma bagunça se você deixar. Responsabilidade única com JavaScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/23/meu-ted-talk-favorito/">Meu TED Talk favorito</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/16/programacao-orientada-a-coincidencia/">Programação orientada à coincidência</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/10/quatro-bons-livros-para-mudar-a-forma-como-voce-ve-escreve-javascript/">Quatro bons livros para mudar a forma como você vê/escreve JavaScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/04/analise-do-livro-pragmatic-thinking-and-learning/">Análise do livro Pragmatic Thinking and Learning</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Thiago Temple -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>


<script type="text/javascript">
var sc_project=5357260;
var sc_invisible=1;
var sc_security="14d7610a";
var scJsHost = (("https:" == document.location.protocol) ?
"https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" + scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="web stats"
href="http://statcounter.com/free-web-stats/" target="_blank"><img
class="statcounter" src="http://c.statcounter.com/5357260/0/14d7610a/1/"
alt="web stats"></a></div></noscript>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'templecoding';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>






<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
